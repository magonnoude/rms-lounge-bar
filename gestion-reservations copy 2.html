<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - RMS Lounge Bar</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #8B4513;
            --secondary-color: #333;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-bg: #1a1a1a;
            --border-color: #dee2e6;
        }
        
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: #f4f4f9; 
            margin: 0; 
            padding: 0; 
            color: #333; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
        }
        
        header { 
            background-color: var(--dark-bg); 
            color: white; 
            padding: 15px 0; 
            text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }
        
        header img { 
            height: 60px; 
            vertical-align: middle; 
        }
        
        .container { 
            max-width: 1400px; 
            margin: 20px auto; 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            flex-grow: 1; 
        }
        
        h1, h2 { 
            color: var(--primary-color); 
            text-align: center; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 10px; 
            margin-bottom: 30px; 
        }
        
        h2 { 
            text-align: left; 
            border: none; 
            font-size: 1.8em; 
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .stat-label {
            color: var(--secondary-color);
            font-size: 0.9em;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            margin-bottom: 50px; 
            table-layout: fixed; 
        }
        
        th, td { 
            padding: 15px; 
            border: 1px solid var(--border-color); 
            text-align: left; 
            vertical-align: middle; 
            word-wrap: break-word; 
        }
        
        th { 
            background-color: var(--secondary-color); 
            color: white; 
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: var(--light-bg);
        }
        
        tr:hover {
            background-color: rgba(139, 69, 19, 0.05);
        }
        
        .btn { 
            padding: 8px 12px; 
            border: none; 
            border-radius: 5px; 
            color: white; 
            cursor: pointer; 
            font-size: 0.9em; 
            margin-right: 5px; 
            transition: all 0.3s ease; 
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-confirm { 
            background-color: var(--success-color); 
        }
        
        .btn-confirm:hover {
            background-color: #218838;
        }
        
        .btn-refuse { 
            background-color: var(--danger-color); 
        }
        
        .btn-refuse:hover {
            background-color: #c82333;
        }
        
        .btn-view { 
            background-color: var(--info-color); 
        }
        
        .btn-view:hover {
            background-color: #138496;
        }
        
        .btn-manage { 
            background-color: var(--warning-color); 
            color: #212529; 
        }
        
        .btn-manage:hover {
            background-color: #e0a800;
        }
        
        .btn-copy {
            background-color: #6c757d;
        }
        
        .btn-copy:hover {
            background-color: #5a6268;
        }
        
        .status-confirmed, .status-paid { 
            color: var(--success-color); 
            font-weight: bold; 
        }
        
        .status-refused { 
            color: var(--danger-color); 
            font-weight: bold; 
        }
        
        .status-pending, .status-awaiting-payment { 
            color: var(--warning-color); 
            font-weight: bold; 
        }
        
        .status-processing {
            color: var(--info-color);
            font-weight: bold;
        }
        
        footer { 
            text-align: center; 
            padding: 20px; 
            margin-top: auto; 
            color: #777; 
            font-size: 0.9em; 
            background-color: var(--dark-bg);
            color: white;
        }
        
        /* Styles pour le Modal (Popup) */
        .modal-backdrop { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 1000; 
            display: none; 
        }
        
        .modal { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            z-index: 1001; 
            width: 90%; 
            max-width: 500px; 
            display: none; 
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 15px; 
            margin-bottom: 20px; 
        }
        
        .modal-header h3 { 
            margin: 0; 
            color: var(--primary-color); 
        }
        
        .modal-close { 
            font-size: 1.5rem; 
            cursor: pointer; 
            border: none; 
            background: none; 
            color: #777;
        }
        
        .modal-close:hover {
            color: var(--danger-color);
        }
        
        .modal-body .form-group { 
            margin-bottom: 15px; 
        }
        
        .modal-body label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500; 
        }
        
        .modal-body input { 
            width: calc(100% - 20px); 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        
        .modal-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
        }
        
        .success-box {
            background: #f0fff0;
            border: 1px solid #d4edda;
            color: #155724;
        }
        
        .error-box {
            background: #fff0f0;
            border: 1px solid #f8d7da;
            color: #721c24;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-weight: 500;
            font-size: 0.9em;
        }
        
        .filter-group select, .filter-group input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            th, td {
                padding: 8px;
                font-size: 0.9em;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                margin-bottom: 5px;
            }
            
            .filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <header>
        <img src="assets/images/logo.png" alt="RMS Lounge Bar Logo">
        <h1>Tableau de Bord Administratif</h1>
    </header>

    <div class="container">
        <div id="auth-container">
            <h1>Acc√®s au Tableau de Bord</h1>
            <input type="password" id="password" placeholder="Mot de passe" style="width: calc(100% - 24px); padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px;">
            <button onclick="checkPassword()" style="padding: 12px 25px; background-color: #8B4513; color: white; border: none; cursor: pointer; border-radius: 4px;">Acc√©der</button>
        </div>

        <div id="dashboard" style="display: none;">
            <h1>Tableau de Bord des Soumissions</h1>
            
            <div class="stats-container" id="stats-container">
                <div class="stat-card">
                    <div class="stat-label">Total R√©servations</div>
                    <div class="stat-number" id="total-reservations">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">En Attente</div>
                    <div class="stat-number" id="pending-reservations">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Messages/Devis</div>
                    <div class="stat-number" id="total-messages">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Paiements En Attente</div>
                    <div class="stat-number" id="pending-payments">0</div>
                </div>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="date-filter">Filtrer par date:</label>
                    <input type="date" id="date-filter" onchange="filterSubmissions()">
                </div>
                <div class="filter-group">
                    <label for="status-filter">Filtrer par statut:</label>
                    <select id="status-filter" onchange="filterSubmissions()">
                        <option value="">Tous les statuts</option>
                        <option value="En attente">En attente</option>
                        <option value="Confirm√©e">Confirm√©e</option>
                        <option value="Refus√©e">Refus√©e</option>
                        <option value="En attente de paiement">En attente de paiement</option>
                        <option value="Confirm√© & Pay√©">Confirm√© & Pay√©</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="search-input">Rechercher:</label>
                    <input type="text" id="search-input" placeholder="Nom, email, t√©l√©phone..." oninput="filterSubmissions()">
                </div>
            </div>

            <h2><i class="fas fa-calendar-check"></i> R√©servations</h2>
            <table id="reservations-table">
                <thead>
                    <tr>
                        <th>Date Demande</th>
                        <th>Date R√©servation</th>
                        <th>Nom & Contact</th>
                        <th>Personnes</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" style="text-align: center;">Chargement...</td>
                    </tr>
                </tbody>
            </table>

            <h2><i class="fas fa-envelope-open-text"></i> Messages & Devis</h2>
            <table id="messages-table">
                <thead>
                    <tr>
                        <th>Date Demande</th>
                        <th>Type</th>
                        <th>Nom & Contact</th>
                        <th>Sujet</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" style="text-align: center;">Chargement...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="modal-backdrop" id="paymentModalBackdrop"></div>
    <div class="modal" id="paymentModal">
        <div class="modal-header">
            <h3 id="modalTitle">G√©n√©rer un lien de paiement</h3>
            <button class="modal-close" onclick="closePaymentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="paymentForm">
                <input type="hidden" id="modalSubmissionId">
                <div class="form-group">
                    <label for="depositAmount">Montant de l'acompte (en FCFA)</label>
                    <input type="number" id="depositAmount" placeholder="Ex: 50000" required min="1000">
                    <small>Minimum: 1,000 FCFA</small>
                </div>
                <button type="submit" class="btn-confirm" style="width: 100%;">
                    <i class="fas fa-link"></i> Cr√©er et Envoyer le lien
                </button>
            </form>
            <div id="modalResult" class="modal-result"></div>
        </div>
    </div>

    <div class="modal-backdrop" id="messageModalBackdrop"></div>
    <div class="modal" id="messageModal">
        <div class="modal-header">
            <h3 id="messageModalTitle">D√©tails du Message</h3>
            <button class="modal-close" onclick="closeMessageModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="messageContent"></div>
        </div>
    </div>

    <footer>
        &copy; <span id="current-year"></span> RMS Lounge Bar - Tableau de Bord Administratif
    </footer>

    <script src="config.js"></script>
    <script>
        document.getElementById('current-year').textContent = new Date().getFullYear();
        const ADMIN_PASSWORD = "rms-lounge-2025"; 
        
        let allSubmissions = [];
        let filteredSubmissions = [];

        function checkPassword() {
            const passwordInput = document.getElementById('password');
            if (passwordInput.value === ADMIN_PASSWORD) {
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                fetchSubmissions();
            } else {
                alert('Mot de passe incorrect.');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        async function fetchSubmissions() {
            const reservationsTable = document.getElementById('reservations-table');
            const messagesTable = document.getElementById('messages-table');
            
            reservationsTable.innerHTML = '<tbody><tr><td colspan="6" style="text-align:center;">Chargement...</td></tr></tbody>';
            messagesTable.innerHTML = '<tbody><tr><td colspan="6" style="text-align:center;">Chargement...</td></tr></tbody>';

            const API_URL = window.CONFIG.API_CONFIG.URL.replace('/form', '/reservations'); 
            const API_KEY = window.CONFIG.API_CONFIG.KEY;

            try {
                const response = await fetch(API_URL, { 
                    headers: { 'x-api-key': API_KEY }
                });
                
                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                
                const submissions = await response.json();
                allSubmissions = submissions;
                filteredSubmissions = [...submissions];
                
                updateStats(submissions);
                displaySubmissions(submissions);
                
            } catch (error) {
                console.error('Erreur:', error);
                reservationsTable.innerHTML = '<tbody><tr><td colspan="6" style="color:red; text-align:center;">Erreur de chargement des donn√©es.</td></tr></tbody>';
                messagesTable.innerHTML = '<tbody><tr><td colspan="6" style="color:red; text-align:center;">Erreur de chargement des donn√©es.</td></tr></tbody>';
            }
        }

        function updateStats(submissions) {
            const totalReservations = submissions.filter(item => item.type === 'reservation').length;
            const pendingReservations = submissions.filter(item => 
                item.type === 'reservation' && item.status === 'En attente'
            ).length;
            
            const totalMessages = submissions.filter(item => item.type !== 'reservation').length;
            const pendingPayments = submissions.filter(item => 
                item.status === 'En attente de paiement'
            ).length;

            document.getElementById('total-reservations').textContent = totalReservations;
            document.getElementById('pending-reservations').textContent = pendingReservations;
            document.getElementById('total-messages').textContent = totalMessages;
            document.getElementById('pending-payments').textContent = pendingPayments;
        }

        function filterSubmissions() {
            const dateFilter = document.getElementById('date-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            filteredSubmissions = allSubmissions.filter(item => {
                let matches = true;
                
                // Filtre par date
                if (dateFilter) {
                    const itemDate = new Date(item.timestamp).toISOString().split('T')[0];
                    matches = matches && itemDate === dateFilter;
                }
                
                // Filtre par statut
                if (statusFilter) {
                    matches = matches && item.status === statusFilter;
                }
                
                // Filtre par recherche
                if (searchTerm) {
                    const searchFields = [
                        item.name || '',
                        item.email || '',
                        item.phone || '',
                        item.subject || '',
                        item.message || ''
                    ];
                    matches = matches && searchFields.some(field => 
                        field.toLowerCase().includes(searchTerm)
                    );
                }
                
                return matches;
            });

            displaySubmissions(filteredSubmissions);
        }

        function displaySubmissions(submissions) {
            const reservationsTable = document.getElementById('reservations-table');
            const messagesTable = document.getElementById('messages-table');
            
            let reservationsHtml = `<thead><tr>
                <th>Date Demande</th><th>Date R√©servation</th><th>Nom & Contact</th>
                <th>Personnes</th><th>Statut</th><th>Actions</th>
            </tr></thead><tbody>`;
            
            let messagesHtml = `<thead><tr>
                <th>Date Demande</th><th>Type</th><th>Nom & Contact</th>
                <th>Sujet</th><th>Statut</th><th>Actions</th>
            </tr></thead><tbody>`;
            
            let reservationsCount = 0;
            let messagesCount = 0;

            submissions.forEach(item => {
                if (item.type === 'reservation') {
                    reservationsCount++;
                    let status = item.status || 'En attente';
                    let statusClass = '';
                    
                    switch(status) {
                        case 'Confirm√©e': statusClass = 'status-confirmed'; break;
                        case 'Refus√©e': statusClass = 'status-refused'; break;
                        case 'En attente': statusClass = 'status-pending'; break;
                        default: statusClass = '';
                    }
                    
                    reservationsHtml += `<tr id="row-${item.submissionsId}">
                        <td>${new Date(item.timestamp).toLocaleString('fr-FR')}</td>
                        <td>${item.date || 'N/A'} √† ${item.time || 'N/A'}</td>
                        <td>${item.name || 'N/A'}<br><small>${item.phone || 'N/A'}</small></td>
                        <td>${item.guests || 'N/A'}</td>
                        <td class="${statusClass}">${status}</td>
                        <td class="action-buttons">
                            ${status === 'En attente' ? 
                                `<button class="btn btn-confirm" onclick="updateStatus('${item.submissionsId}', 'Confirm√©e')">
                                    <i class="fas fa-check"></i> Confirmer
                                </button>
                                <button class="btn btn-refuse" onclick="updateStatus('${item.submissionsId}', 'Refus√©e')">
                                    <i class="fas fa-times"></i> Refuser
                                </button>` : 
                                `<span>Trait√©e</span>`
                            }
                        </td>
                    </tr>`;
                } else {
                    messagesCount++;
                    let status = item.status || 'En attente';
                    let statusClass = '';
                    let typeLabel = item.type === 'event_inquiry' ? 'üéâ Devis' : 'üìß Contact';
                    
                    switch(status) {
                        case 'Confirm√© & Pay√©': statusClass = 'status-paid'; break;
                        case 'En attente de paiement': statusClass = 'status-awaiting-payment'; break;
                        case 'En attente': statusClass = 'status-pending'; break;
                        default: statusClass = '';
                    }
                    
                    messagesHtml += `<tr id="row-${item.submissionsId}">
                        <td>${new Date(item.timestamp).toLocaleString('fr-FR')}</td>
                        <td>${typeLabel}</td>
                        <td>${item.name || 'N/A'}<br><small>${item.email || 'N/A'}</small></td>
                        <td>${item.subject || 'Sans sujet'}</td>
                        <td class="${statusClass}">${status}</td>
                        <td class="action-buttons">
                            <button class="btn btn-view" onclick='showMessageModal(${JSON.stringify(item)})'>
                                <i class="fas fa-eye"></i> Voir
                            </button>
                            ${item.type === 'event_inquiry' && status === 'En attente' ? 
                                `<button class="btn btn-manage" onclick="openPaymentModal('${item.submissionsId}', '${item.name}')">
                                    <i class="fas fa-euro-sign"></i> Devis
                                </button>` : 
                                ''
                            }
                            ${item.paymentUrl ? 
                                `<button class="btn btn-copy" onclick="copyPaymentLink('${item.paymentUrl}')">
                                    <i class="fas fa-copy"></i> Lien
                                </button>` : 
                                ''
                            }
                        </td>
                    </tr>`;
                }
            });

            reservationsHtml += `</tbody>`;
            messagesHtml += `</tbody>`;

            reservationsTable.innerHTML = reservationsCount > 0 ? reservationsHtml : 
                '<tbody><tr><td colspan="6" style="text-align:center;">Aucune r√©servation √† afficher.</td></tr></tbody>';
                
            messagesTable.innerHTML = messagesCount > 0 ? messagesHtml : 
                '<tbody><tr><td colspan="6" style="text-align:center;">Aucun message √† afficher.</td></tr></tbody>';
        }
        
        function showMessageModal(item) {
            const messageContent = `
                <div style="margin-bottom: 20px;">
                    <h4>Informations du client</h4>
                    <p><strong>Nom:</strong> ${item.name || 'N/A'}</p>
                    <p><strong>Email:</strong> ${item.email || 'N/A'}</p>
                    <p><strong>T√©l√©phone:</strong> ${item.phone || 'N/A'}</p>
                    <p><strong>Date:</strong> ${new Date(item.timestamp).toLocaleString('fr-FR')}</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <h4>Sujet</h4>
                    <p>${item.subject || 'Aucun sujet sp√©cifi√©'}</p>
                </div>
                <div>
                    <h4>Message</h4>
                    <p style="white-space: pre-wrap;">${item.message || 'Aucun message'}</p>
                </div>
                ${item.paymentUrl ? `
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h4>Informations Paiement</h4>
                    <p><strong>Statut:</strong> ${item.status || 'N/A'}</p>
                    <p><strong>Montant acompte:</strong> ${item.depositAmount ? item.depositAmount + ' FCFA' : 'N/A'}</p>
                    <p><strong>Lien de paiement:</strong></p>
                    <input type="text" value="${item.paymentUrl}" readonly 
                           style="width: 100%; padding: 5px; margin: 5px 0; border: 1px solid #ddd;">
                    <button onclick="copyToClipboard('${item.paymentUrl}')" class="btn btn-copy">
                        <i class="fas fa-copy"></i> Copier
                    </button>
                </div>
                ` : ''}
            `;
            
            document.getElementById('messageModalTitle').textContent = `Message de ${item.name || 'Client'}`;
            document.getElementById('messageContent').innerHTML = messageContent;
            document.getElementById('messageModal').style.display = 'block';
            document.getElementById('messageModalBackdrop').style.display = 'block';
        }

        function closeMessageModal() {
            document.getElementById('messageModal').style.display = 'none';
            document.getElementById('messageModalBackdrop').style.display = 'none';
        }

        async function updateStatus(id, newStatus, buttonElement) {
            const API_URL = window.CONFIG.API_CONFIG.URL.replace('/form', `/reservations/${id}`);
            const API_KEY = window.CONFIG.API_CONFIG.KEY;
            
            const originalText = buttonElement ? buttonElement.innerHTML : '';
            if (buttonElement) {
                buttonElement.innerHTML = '<span class="loading"></span>';
                buttonElement.disabled = true;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': API_KEY
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) throw new Error('Erreur lors de la mise √† jour');

                // Mettre √† jour l'affichage localement
                const row = document.getElementById(`row-${id}`);
                if (row) {
                    const statusCell = row.querySelector('td:nth-child(5)');
                    statusCell.textContent = newStatus;
                    statusCell.className = newStatus === 'Confirm√©e' ? 'status-confirmed' : 
                                         newStatus === 'Refus√©e' ? 'status-refused' : 'status-pending';
                    
                    // Mettre √† jour les actions
                    const actionsCell = row.querySelector('td:last-child');
                    actionsCell.innerHTML = '<span>Trait√©e</span>';
                }

                // Mettre √† jour les donn√©es
                const itemIndex = allSubmissions.findIndex(item => item.submissionsId === id);
                if (itemIndex !== -1) {
                    allSubmissions[itemIndex].status = newStatus;
                    updateStats(allSubmissions);
                }

            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la mise √† jour du statut');
            } finally {
                if (buttonElement) {
                    buttonElement.innerHTML = originalText;
                    buttonElement.disabled = false;
                }
            }
        }

        // --- FONCTIONS POUR LE MODAL DE PAIEMENT ---
        const modal = document.getElementById('paymentModal');
        const modalBackdrop = document.getElementById('paymentModalBackdrop');
        
        function openPaymentModal(submissionId, name) {
            document.getElementById('modalTitle').textContent = `Acompte pour : ${name}`;
            document.getElementById('modalSubmissionId').value = submissionId;
            document.getElementById('depositAmount').value = '';
            document.getElementById('modalResult').innerHTML = '';
            document.getElementById('paymentForm').style.display = 'block';
            modal.style.display = 'block';
            modalBackdrop.style.display = 'block';
        }

        function closePaymentModal() {
            modal.style.display = 'none';
            modalBackdrop.style.display = 'none';
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Lien copi√© dans le presse-papier !');
            }).catch(err => {
                console.error('Erreur de copie:', err);
                // Fallback pour les anciens navigateurs
                const tempInput = document.createElement('input');
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert('Lien copi√© !');
            });
        }

        function copyPaymentLink(url) {
            copyToClipboard(url);
        }

        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = this.querySelector('button');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span> Cr√©ation...';

            const submissionId = document.getElementById('modalSubmissionId').value;
            const amount = parseInt(document.getElementById('depositAmount').value, 10);
            
            if (!amount || amount <= 0 || amount < 1000) {
                alert('Veuillez entrer un montant valide (minimum 1000 FCFA).');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }

            const API_URL = window.CONFIG.API_CONFIG.URL.replace('/form', `/reservations/${submissionId}/create-payment`);
            const API_KEY = window.CONFIG.API_CONFIG.KEY;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'x-api-key': API_KEY 
                    },
                    body: JSON.stringify({ amount: amount })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || result.message || 'La cr√©ation du lien a √©chou√©.');
                }

                document.getElementById('modalResult').innerHTML = `
                    <div class="success-box">
                        <p style="color: green; font-weight: bold;">
                            <i class="fas fa-check-circle"></i> Lien cr√©√© avec succ√®s !
                        </p>
                        <p>Transaction ID: <code>${result.transactionId || 'N/A'}</code></p>
                        <p>Le client recevra un email avec le lien de paiement.</p>
                    </div>
                    <div style="margin: 15px 0;">
                        <label>Lien de paiement :</label>
                        <input type="text" value="${result.paymentUrl}" readonly 
                               style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;"
                               onclick="this.select()">
                        <button onclick="copyToClipboard('${result.paymentUrl}')" class="btn btn-copy">
                            <i class="fas fa-copy"></i> Copier le lien
                        </button>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="window.open('${result.paymentUrl}', '_blank')" class="btn btn-view">
                            <i class="fas fa-external-link-alt"></i> Tester le lien
                        </button>
                    </div>
                `;
                
                this.style.display = 'none';
                
                // Rafra√Æchir les donn√©es apr√®s un d√©lai
                setTimeout(() => {
                    fetchSubmissions();
                    closePaymentModal();
                }, 3000);

            } catch (error) {
                console.error('Erreur de cr√©ation de lien:', error);
                document.getElementById('modalResult').innerHTML = `
                    <div class="error-box">
                        <p style="color: red; font-weight: bold;">
                            <i class="fas fa-exclamation-circle"></i> Erreur
                        </p>
                        <p>${error.message}</p>
                        <p>Veuillez v√©rifier la configuration de FedaPay et r√©essayer.</p>
                    </div>
                `;
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Fermer les modals en cliquant √† l'ext√©rieur
        modalBackdrop.addEventListener('click', closePaymentModal);
        document.getElementById('messageModalBackdrop').addEventListener('click', closeMessageModal);

        // G√©rer la touche √âchap
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePaymentModal();
                closeMessageModal();
            }
        });

        // Focus sur le champ de mot de passe au chargement
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('password').focus();
        });

    </script>
</body>
</html>